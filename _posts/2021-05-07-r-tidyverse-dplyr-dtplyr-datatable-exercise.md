---
layout: post
title:  "æ›´å¿«çš„Rï¼šä¸€ä¸ªå®ä¾‹"
date:   2021-05-07 02:55 +0800
---

æœ€è¿‘ç© Rï¼Œå‡ºç°äº†å¾ˆå¤šæœ‰æ„æ€çš„ç”»é¢ï¼Œä»Šå¤©æ¥å¤ç›˜ä¸€åˆ°é”™é¢˜ï¼Œæ¸©æ•…çŸ¥æ–°ã€‚åˆå§‹é—®é¢˜æ˜¯è¿™æ ·çš„ï¼šå¸®å¿™çœ‹çœ‹ç”¨æˆ·çš„è´­ä¹°é—´éš”ï¼Œä¸ºæ²Ÿé€šæœºåˆ¶æä¾›æ•°æ®å‚è€ƒã€‚ğŸ¤”ï¸ å¼€åŠ¨ï¼Œ38ä¸‡è¡Œæ•°æ®ï¼Œç¬¬ä¸€é”¤å­ä¸‹å»ï¼Œæ•²å‡ºæ¥çš„ä»£ç å¦‚ä¸‹ï¼š

```r
library(tidyverse)
library(lubridate)

data %>%
  filter(created_at >= '2020-07-01',
         created_at < '2021-01-01',
         is.na(refund_state)) %>%
  select(member_no, union_no, created_at) %>% 
  mutate(created_at = date(created_at)) %>%
  group_by(member_no, union_no) %>%
  slice_max(created_at, n = 1) %>% 
  ungroup() %>%
  select(-union_no) %>%
  distinct() %>%
  group_by(member_no) %>%
  arrange(created_at) %>%
  mutate(
    n_days = n(),
    tier = case_when(
      n_days == 1 ~ "1d",
      n_days == 2 ~ "2d",
      n_days == 3 ~ "3d",
      n_days  > 3 ~ "3d+"),
    previous = lag(created_at),
    dd = interval(previous, created_at) %/% days(1))
```

ä½¿ç”¨ tidyverse è¯­æ³•çš„å¥½å¤„ä¹‹ä¸€å°±æ˜¯æ˜“è¯»ï¼Œè¿™é‡Œçš„é€»è¾‘æ˜¯è¿™æ ·çš„ï¼š

- `filter` ç­›é€‰å¿…è¦çš„è¡Œ
- `select` ç­›é€‰å¿…è¦çš„åˆ—
- `mutate` æ›´æ”¹æ—¥æœŸæ—¶é—´ä¸ºä»…æ—¥æœŸï¼ˆé—´éš”æ—¥ï¼Œä¸éœ€è¦ç†ä¼šæ—¶é—´ç‚¹ï¼‰
- `group_by` æŒ‰ç”¨æˆ·å’Œå•å·è¿›è¡Œåˆ†ç»„
- `filter` åŒä¸€å•é€‰æœ€å¤§æ—¥æœŸï¼ˆå‘ç°åŒä¸€å•æœ‰æ—¶é—´ä¸ä¸€è‡´çš„æƒ…å†µï¼‰
- `ungroup` å–æ¶ˆåˆ†ç»„
- `select` ä¸¢æ‰å•å·åˆ—
- `distinct` é’ˆå¯¹å‰©ä¸‹çš„ç”¨æˆ·idå’Œä¸‹å•æ—¥æœŸï¼Œå»é‡
- `group_by` å†æ¬¡æŒ‰ç”¨æˆ·idåˆ†ç»„
- `arrange` æŒ‰æ—¥æœŸåœ¨åˆ†ç»„å†…æ’åº
- `mutate` è®¡ç®—æ´»è·ƒï¼ˆè´­ä¹°ï¼‰å¤©æ•°å¹¶æŒ‰å¤©æ•°åˆ†å±‚
- `lag` æ‰¾å‡ºå½“å‰æ—¥æœŸçš„ä¸Šä¸€ä¸ªæ—¥æœŸ
- `interval` è®¡ç®—ä¸¤ä¸ªæ—¥æœŸä¹‹é—´çš„é—´éš”

## è½¬æ¢æ€è·¯

è·‘è·‘çœ‹ï¼ŒçŒœæ€ä¹ˆç€ï¼Ÿçœ‹èµ·æ¥å¥½åƒæ²¡å•¥é—®é¢˜ï¼Œè·‘èµ·æ¥æ…¢çš„è¦æ­»ï¼Œä¸¤åˆ†é’Ÿæ²¡æœ‰ç»“æŸè¿¹è±¡ï¼Œè¿™ç§æƒ…å†µï¼Œæ˜¾ç„¶æ˜¯å“ªé‡ŒçŠ¯å‚»äº†ï¼Œå¾—å…ˆæªå‡ºæ˜æ˜¾çš„æ€§èƒ½ç“¶é¢ˆå†è¯´ã€‚è¿™æ—¶å€™ tidyverse è¯­æ³•çš„å¦ä¸€ä¸ªå¥½å¤„åˆä½“ç°å‡ºæ¥äº†ï¼Œå®ƒçš„ä»£ç ç»„ç»‡å½¢å¼ï¼Œå¯¹äºä¸€è¡Œè¡Œæˆ–ä¸€å—å—çš„é—®é¢˜æ’æŸ¥ï¼Œéå¸¸å‹å¥½ã€‚æˆ‘ä»¬å¯ä»¥å…ˆé‡‡ç”¨äºŒåˆ†æ³•ï¼Œä»¥ `ungroup` ä¸ºç•Œï¼Œå…ˆçœ‹ä¸ŠåŠéƒ¨åˆ†ã€‚åˆ°åº•æ…¢åœ¨å“ªé‡Œï¼Œæˆ‘ä»¬å¯ä»¥å€ŸåŠ© profvis è¿™ä¸ªå·¥å…·æ¥åˆ†æï¼ŒæŠŠéœ€è¦æ£€æµ‹çš„ä»£ç å¡åˆ° `profvis({...})` å†…éƒ¨å³å¯ã€‚ä¸ŠåŠéƒ¨åˆ†çš„ç»“æœå¦‚ä¸‹å›¾

![slice_max without sort](/files/2021/slice_max_wo_sort.png)

### slice_ å’Œæ—¶åŒº

ç›´æ¥ä½¿ç”¨ `slice_max` ç­›é€‰æœ€å¤§å€¼æ˜¯ä¸åˆé€‚çš„ï¼Œæ¶ˆè€—äº† 11 ç§’å¤šï¼Œå…ˆ `arrange` å¯¹è¿™ä¸¤ä¸ªå…³é”®åˆ—è¿›è¡Œæ’åºï¼Œå† `slice_head/tail` ä¼šå¿«ä¸å°‘ï¼Œä½†å®ƒæ˜¾ç„¶ä¸æ˜¯å¤§å¤´ï¼Œè¿™åæ¥ç§’ä¸ä¼šæ˜¯æ¼«é•¿æ— åº”ç­”çš„ä¸»è¦åŸå› ã€‚

å¦å¤–ï¼Œæˆ‘ä»¬çš„ç›®çš„ï¼Œåªæ˜¯ä¸ºäº†è·å¾—å»é‡çš„ç”¨æˆ·idå’Œä¸‹å•æ—¥æœŸï¼Œå¼•å…¥ `union_no` å•å·ä¼¼ä¹æ¯«æ— å¿…è¦ï¼Œä½†æ˜¯è¿™ä¸€é¡¿æ“ä½œåªæ˜¯ä¸ºäº†ä¿®æ­£ä¸€å•è·¨ä¸¤ä¸ªæ—¥æœŸçš„æƒ…å†µï¼›ä½†è¯åˆè¯´å›æ¥ï¼Œè™½ç„¶å‘ç°å­˜åœ¨ä¸€å•æœ‰å¤šä¸ªæ—¶æˆ³çš„æƒ…å†µï¼Œåˆ°åº•è·¨æ²¡è·¨æ—¥æœŸï¼Œå…¶å®å¯ä»¥å¦è¡Œæ¢æŸ¥ï¼›è€Œæ¢æŸ¥çš„ç»“æœæ˜¯ï¼Œæ²¡æœ‰ ğŸ˜‚ï¸ï¼Œæ‰€ä»¥ä¸ŠåŠéƒ¨åˆ†çš„æœ€ç»ˆçš„æ”¹è¿›ç»“æœå¦‚ä¸‹ï¼š

```r
data %>%
  filter(created_at >= '2020-07-01',
         created_at < '2021-01-01',
         is.na(refund_state)) %>%
  select(member_no, created_at) %>% 
  mutate(created_at = date(created_at)) %>%
  distinct()
  # ...
```

ä¸ŠåŠéƒ¨åˆ†ï¼Œå°±åªæ˜¯ä¸€ç™¾æ¯«ç§’å·¦å³çš„äº‹æƒ…äº†ã€‚ä½†æ˜¯é—®é¢˜åˆæ¥äº†ï¼Œå‘ç°ä¸¤éƒ¨ç”µè„‘çš„è¿è¡Œç»“æœä¸ä¸€è‡´ï¼Œè¿˜å¥½ç•¥æœ‰ç»éªŒï¼ŒçŒœæµ‹æ˜¯æ—¶åŒºå¤„ç†çš„é—®é¢˜ï¼Œç¼–è¾‘ `~/.Renviron` æ–‡ä»¶ï¼ŒåŠ å…¥ `TZ` å‚æ•°å³å¯ï¼Œæˆ‘çš„é…ç½®å¦‚ä¸‹ï¼Œå…¶ä»–é€‰é¡¹å¯å‚è€ƒï¼š

```shell
TZ="UTC"
RETICULATE_PYTHON="/usr/local/bin/python3"
R_MAX_VSIZE=16Gb

http_proxy=http://127.0.0.1:1091/
https_proxy=http://127.0.0.1:1091/
```

å†æ¥çœ‹ååŠéƒ¨åˆ†ï¼Œå®ƒåªå¯èƒ½æ…¢åœ¨ mutate å†…éƒ¨ï¼Œæ¨æµ‹ç€ï¼Œå…ˆæŠŠ interval è¿™è¡Œæ³¨é‡Šæ‰ï¼Œè¿è¡Œç»“æœå¦‚ä¸‹å›¾ï¼š

![case_when and lag](/files/2021/case_when_lag.png)

`case_when` å’Œ `lag` éƒ½å¾ˆæ…¢ï¼ŒåŠ èµ·æ¥åå‡ ç§’ï¼Œä¸è¿‡ï¼Œè¿™åå‡ ç§’ä¹Ÿè®©æœ€ç»ˆ boss æµ®å‡ºäº†æ°´é¢ï¼š`interval` ã€‚è¿™é‡Œå…¶å®æœ‰ç‚¹å¥‡æ€ªï¼Œå•æ‹¿å‡ºæ¥è·‘ï¼Œ `interval(df$a, df$b) %/% days(1)` æ˜¯å¾ˆå¿«çš„ï¼Œåº”è¯¥æ˜¯åµŒå¥—åˆ° `mutate` å†…éƒ¨ä¹‹åï¼Œå¤±å»äº† *vectorized* ç‰¹æ€§ï¼Œå˜æˆäº† row-wise çš„å¾ªç¯ã€‚æ”¹ç”¨ base R æä¾›çš„ lagged differences ç®—æ³•ä¹‹åï¼Œå°±ç›´æ¥å…‰é€Ÿäº†ï¼š

```r
data %>%
  filter(created_at >= '2020-07-01',
         created_at < '2021-01-01',
         is.na(refund_state)) %>%
  select(member_no, created_at) %>% 
  mutate(created_at = date(created_at)) %>%
  distinct() %>% 
  group_by(member_no) %>%
  arrange(created_at) %>%
  mutate(
    n_days = n(),
    tier = case_when(
      n_days == 1 ~ "1d",
      n_days == 2 ~ "2d",
      n_days == 3 ~ "3d",
      n_days > 3 ~ "3d+"
    ),
    dd = c(0, diff(created_at)))

```

æ”¹åŠ¨å¦‚ä¸Šï¼ŒåŸ `lag` å’Œ `interval` å¹¶ä½œä¸€è¡Œ `c(0, diff(created_at)))`ï¼Œè‡³æ­¤ï¼Œä»é¥é¥æ— æœŸåˆ°åå‡ ç§’è·‘å®Œï¼Œç®—æ˜¯ä¸€ä¸ªé‡Œç¨‹ç¢‘ï¼Œæœ€åè¿˜å‰©ä¸‹ä¸€ä¸ª case_whenï¼Œä¸€æ—¶æƒ³ä¸å‡ºä»€ä¹ˆåŠæ³•ã€‚

![case_when](/files/2021/case_when.png)

## æ›´æ¢å·¥å…·

data.table æ˜¯ R å®‡å®™å½“ä¸­ä»¥æ€§èƒ½è§é•¿çš„æ•°æ®å¤„ç†åº“ï¼Œå®ƒçš„è¯­æ³•æŠ½è±¡è€Œç®€æ´ï¼Œå‡ ä¹ä¸€å¥è¯å°±å¯ä»¥æ¦‚æ‹¬ï¼š`DT[i, j, by]`ã€‚åªæ˜¯ä¸€æ—¦ chain åˆ°ä¸€èµ·ï¼Œï¼ˆè‡³å°‘å¯¹æˆ‘æ¥è¯´ï¼‰å°±æœ‰ç‚¹ç»•æ¯›çº¿äº†ï¼Œå› ä¸ºå®ƒçš„ chain æ˜¯è¿™æ ·çš„ï¼š

```r
# data.table åŸç”Ÿ chain
dt[][
  ][
    ][
      ]

# å½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨ magrittr çš„ pipe
# ä½†å†…å®¹ä¸€å¤šï¼Œæ‹¬å·é‡Œé¢çš„å†…å®¹å°±ä¸å¥½åˆ†å‰²äº†
dt %>%
  .[] %>%
  .[] %>%
  .[]
```

tidyverse è¯­æ³•è™½ç„¶çœ‹ä¼¼ç½—å—¦ï¼Œä½†æ˜¯å¯¹æ¯”ä¹‹ä¸‹ï¼Œåœ¨ baseã€tidyã€data.table è¿™ä¸‰å¤§å®‡å®™å½“ä¸­ï¼Œä¸€ç‚¹ç‚¹è¯­æ³•å†—ä½™ï¼Œæ¢æ¥æ›´å¥½çš„æ’ç‰ˆå’Œé˜…è¯»ä¾¿åˆ©ï¼Œè¿˜æ˜¯éå¸¸å€¼å¾—çš„ã€‚ä¸ºäº†äºŒè€…å…¼å¾—ï¼Œtidyverse è¿˜åœ¨ dplyr çš„åŸºç¡€ä¸Šï¼Œæä¾›äº†ä¸€ä¸ªæ¡¥æ¥æ–¹æ¡ˆ dtplyrï¼Œæ¡¥æ¥çš„åç«¯å°±æ˜¯ data.tableã€‚å®ƒä¼šåœ¨è¿è¡Œä¹‹å‰ï¼Œå…ˆå°† dplyr è¯­æ³•è½¬ä¹‰ä¸º data.table è¯­æ³•ï¼Œä»¥æœŸå®ç°ã€Œå†™çš„èˆ’æœã€ã€Œè·‘çš„è¿˜å¿«ã€çš„åŒé‡ç›®çš„ã€‚è¿™ä¸ªæ–¹æ¡ˆåœ¨ä¹‹å‰çš„ä¸€äº›å°æµ‹è¯•ä¸­ï¼Œæˆ‘å¹¶æ²¡å‘ç°æœ‰å¤§çš„æ€§èƒ½å·®å¼‚ï¼Œæœ€è¿‘é‡å»ºäº† R ç¯å¢ƒï¼Œè¾ƒä¸ºä»”ç»†åœ°å®Œæˆäº† openblas å’Œ libomp çš„ç¼–è¯‘æ”¯æŒï¼Œæ­£å¥½ä¸€è¯•ã€‚

ä½¿ç”¨ dtplyr å¹¶ä¸ç®—éº»çƒ¦ï¼Œå¯ä»¥æŠŠ dplyr è‰ç¨¿çº¸ï¼Œæ³¨æ„ä¸¤ä»¶äº‹å°±å¥½ï¼šä¸€æ˜¯é€šè¿‡ data.table æ¥è¯»å…¥æ•°æ®ï¼Œè·å¾— data.table ç»“æ„ï¼›äºŒæ˜¯ï¼Œæ“ä½œçš„å¼€å¤´éœ€è¦è°ƒç”¨ `lazy_dt` åˆ›å»ºï¼ˆæˆ–è€…è¯´å‘ŠçŸ¥è¿™æ˜¯ï¼‰ä¸€ä¸ªè‰ç¨¿ï¼Œä¸­é—´ dplyr ç­‰ tidyverse é‚£äº›é€»è¾‘æ­£å¸¸å†™ï¼Œç»“å°¾å†è°ƒç”¨ `as_tibble` æˆ– `as.data.table` æˆ– `as.data.frame` æ¥è·å¾—å®Œæ•´ç»“æœï¼ˆæˆ–è€…è¯´å‘ŠçŸ¥æ‰§è¡Œï¼‰ã€‚

```r
dt %>% # <----
  lazy_dt() %>% # <----
  filter(created_at >= '2020-07-01',
         created_at < '2021-01-01',
         is.na(refund_state)) %>%
  select(member_no, created_at) %>%
  mutate(created_at = date(created_at)) %>%
  distinct() %>%
  group_by(member_no) %>%
  arrange(created_at) %>%
  mutate(
    n_days = n(),
    tier = case_when(
      n_days == 1 ~ "1d",
      n_days == 2 ~ "2d",
      n_days == 3 ~ "3d",
      n_days > 3 ~ "3d+"
    ),
    dd = c(0, diff(created_at))
  ) %>%
  as.data.table() # <----
```

![the data.table way](/files/2021/data_table_way.png)

æ€§èƒ½å·®å¼‚éå¸¸æ˜æ˜¾ï¼Œ`case_when` è½¬ä¹‰æˆè·‘åœ¨ data.table ä¸Šçš„ `fcase` ä¹‹åï¼Œå¿«äº†ä¸€ä¸ªæ•°é‡çº§ã€‚ä¸¤ä¸ªéƒ¨åˆ†åŠ ä¸€èµ·æ€»å…±è€—æ—¶çº¦ä¸¤ç§’é’Ÿï¼Œå¹¶ä¸”æ³¨æ„å†…å­˜é‚£ä¸€æ ï¼Œç›¸è¾ƒäº dplyrï¼Œæ¶ˆè€—ä¹Ÿå°äº†å¾ˆå¤šã€‚

```r
# system.time({...})

   user  system elapsed 
  2.915   0.037   2.098 
```

æŠŠæœ«å°¾çš„ `as.data.table()` æ›¿æ¢æˆ `show_query()` å³å¯è·å¾—ç¿»è¯‘ç»“æœï¼Œå¦‚ä¸‹ï¼š

```r
unique(`_DT2`[created_at >= "2020-07-01" & created_at < "2021-01-01" & 
    is.na(refund_state), .(member_no, created_at)][, `:=`(created_at = date(created_at))])[order(created_at)][, 
    `:=`(c("n_days", "tier", "dd"), {
        n_days <- .N
        tier <- fcase(n_days == 1, "1d", n_days == 2, "2d", n_days == 
            3, "3d", n_days > 3, "3d+")
        dd <- c(0, diff(created_at))
        .(n_days, tier, dd)
    }), by = .(member_no)]
```

ä½¿ç”¨ dtplyr å’Œ data.table å‰åçš„ç«ç„°å›¾ï¼Œä¹Ÿèƒ½çœ‹å¾—å‡ºå¤§ä¸åŒï¼š

![data.table flame graph](/files/2021/data_table_flame.png)

![dplyr flame graph](/files/2021/dplyr_flame.png)

## å°ç»“

```r
Unit: seconds
 expr       min        lq      mean    median        uq      max neval
   dp 18.792854 19.282197 19.793766 19.602105 20.323187 20.96849     5
   dt  2.163451  2.220804  2.235009  2.234266  2.277006  2.27952     5

# æ³¨é‡Šæ‰ case_when å’Œ diff ä¸¤å¤„è¿ç®—ä¹‹åçš„å¯¹æ¯”
Unit: milliseconds
 expr       min        lq      mean    median       uq       max neval
   dp 1874.7782 1932.8641 2036.7339 2041.8302 2060.804 2273.3928     5
   dt  134.3752  138.8937  155.6884  141.1073  142.066  221.9998     5

```

å¯¹äºæ•°åä¸‡åŠä»¥ä¸Šè§„æ¨¡çš„æ•°æ®é›†ï¼Œdtplyr + data.table é€Ÿåº¦æå‡æ˜æ˜¾ã€‚

![interval plot](/files/2021/plot.png)

